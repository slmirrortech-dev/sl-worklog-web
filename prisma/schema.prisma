generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ================================
// User (사용자)
// ================================
model User {
  id                       String   @id @default(cuid())     // UUID (PK)
  supabaseUserId           String?  @unique                 // Supabase Auth User ID
  email                    String?  @unique                 // 이메일 (형식: userId@temp.invalid)
  userId                   String   @unique                 // 사번 (로그인 ID)
  name                     String                           // 사용자 이름
  hireDate                 String?                          // 입사일 (8자리 yyyymmdd, 선택값)
  role                     Role     @default(WORKER)        // 사용자 권한
  mustChangePassword       Boolean  @default(true)          // 초기 비밀번호 변경 필수 여부
  licensePhotoUrl          String?                          // 면허증 이미지 경로
  isActive                 Boolean  @default(true)          // 활성 여부
  deactivatedAt            DateTime?                        // 비활성화 시점
  createdAt                DateTime @default(now())         // 생성 시각

  // Relations
  processSlot              ProcessSlot[]
  DefectLog                DefectLog[]
  TrainingLog              TrainingLog[]
  WorkplaceSnapshot        WorkplaceSnapshot[]

  @@map("users")

}

// ================================
// TrainingLog (교육 기록)
// ================================
model TrainingLog {
  id                       String   @id @default(cuid())     // UUID (PK)
  trainedAt                DateTime @default(now())           // 교육일시

  workerId                 String
  worker                   User @relation(fields: [workerId], references: [id])

  title                    String                            // 교육명
  instructor               String                            // 교육자

  createdAt                DateTime @default(now())
  createdBy                String                            // 기록한 관리자 uuid

  @@map("training_logs")
}

// ================================
// DefectLog (불량유출 기록)
// ================================
model DefectLog {
  id                       String   @id @default(cuid())     // UUID (PK)
  occurredAt               DateTime @default(now())          // 발생 일시

  workerId                 String
  worker                   User @relation(fields: [workerId], references: [id])

  lineName                 String                            // 라인명
  className                String                            // 반 이름 (1반, 2반, 서브반 등) - 필수
  shiftType                ShiftType                         // 교대조 타입 (주간/야간)
  processName              String                            // 공정명
  memo                     String                            // 메모

  createdAt                DateTime @default(now())
  createdBy                String                            // 기록한 관리자 uuid

  @@map("defect_logs")
}

// ================================
// WorkplaceSnapshot (작업장 현황 백업)
// ================================
model WorkplaceSnapshot {
  id                       String   @id @default(cuid())     // UUID (PK)
  data                     Json                              // 전체 작업장 현황 데이터 (JSON)

  createdAt                DateTime @default(now())
  createdByUserId          String?                           // 생성자 uuid (자동 백업이면 null)
  createdByUserName        String?                           // 생성자 이름 (삭제 후에도 유지)
  createdByUserUserId      String?                           // 생성자 사번 (삭제 후에도 유지)
  createdByUser            User?    @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@map("workplace_snapshots")
}


// ================================
// Role (사용자 권한)
// ================================
enum Role {
  ADMIN // 관리자
  MANAGER // 작업반장
  WORKER // 작업자
}

// ================================
// WorkClass (반)
// ================================
model WorkClass {
  id              String   @id @default(cuid())     // UUID (PK)
  name            String   @unique                  // 이름
  displayOrder    Int      @default(0)              // 순서

  line FactoryLine[]

  @@map("work_classes")
}

// ================================
// SystemConfig (전역 설정)
// ================================
model FactoryConfig {
  id           String   @id @default("global_config") // 고정 ID 사용
  processCount Int      @default(7)                   // 공정 하위 프로세스의 고정 개수

  @@map("factory_configs")
}


// ================================
// FactoryLine (공정라인)
// ================================
model FactoryLine {
  id              String   @id @default(cuid())     // UUID (PK)
  name            String                            // 이름
  displayOrder    Int                               // 순서

  workClassId     String
  workClass       WorkClass   @relation(fields: [workClassId], references: [id], onDelete: Cascade)

  shifts       LineShift[]

  @@map("factory_lines")
}

// ================================
// LineShift (근무조 - 주/야 상태관리)
// ================================
model LineShift {
  id              String   @id @default(cuid())     // UUID (PK)
  type            ShiftType                         // 타입 (주간/야간)
  status          WorkStatus                        // 상태 (정상/잔업/연장)

  lineId          String                            // 소속 라인 아이디
  line            FactoryLine @relation(fields: [lineId], references: [id], onDelete: Cascade)

  slots           ProcessSlot[]                      // 이 근무조에 속한 프로세스들

  @@unique([lineId, type]) // 한 라인에 주간/야간 타입은 하나씩만 존재
  @@map("line_shifts")
}

// ================================
// ProcessSlot (공정 프로세스)
// ================================
model ProcessSlot {
  id           String       @id @default(cuid())
  name         String
  slotIndex    Int          @default(0)

  shiftId      String
  shift        LineShift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  // 작업자
  workerId     String?
  workerStatus WorkerStatus   @default(NORMAL) // Enum 타입 확인 필요
  worker       User?        @relation(fields: [workerId], references: [id])

  @@unique([shiftId, name]) // 한 교대조 내에 이름이 겹치면 안됨
  @@unique([shiftId, slotIndex]) // 한 교대조 내에 순서가 겹치면 안됨
  @@map("process_slots")
}

// ================================
// Enums
// ================================
enum ShiftType {
  DAY
  NIGHT
}

enum WorkStatus {
  NORMAL    // 정상
  OVERTIME  // 잔업
  EXTENDED  // 연장
}

enum WorkerStatus {
  NORMAL    // 정상
  OVERTIME  // 잔업
}
